package main

import (
	"io/ioutil"
	"log"
	"os"
	"os/exec"
	"strings"
	"syscall"
)

func getenv(key, def string) string {
	v := os.Getenv(key)
	if v == "" {
		return def
	}
	return v
}

func main() {
	// Read template
	tplPath := "/config.json.tpl"
	data, err := ioutil.ReadFile(tplPath)
	if err != nil {
		log.Fatalf("failed to read template %s: %v", tplPath, err)
	}
	s := string(data)

	// Gather envs with defaults
	proto := getenv("PROTO", "vless")
	user := getenv("USER_ID", getenv("UUID", "changeme"))
	wspath := getenv("WS_PATH", "/ws")
	network := getenv("NETWORK", "ws")
	port := getenv("PORT", "8080")

	// replace placeholders
	repl := map[string]string{
		"__PROTO__": proto,
		"__USER_ID__": user,
		"__WS_PATH__": wspath,
		"__NETWORK__": network,
		"__PORT__": port,
	}
	for k,v := range repl {
		s = strings.ReplaceAll(s, k, v)
	}

	// write output
	outPath := "/etc/xray/config.json"
	if err := os.MkdirAll("/etc/xray", 0755); err != nil {
		log.Fatalf("failed to create dir: %v", err)
	}
	if err := ioutil.WriteFile(outPath, []byte(s), 0644); err != nil {
		log.Fatalf("failed to write config: %v", err)
	}

	// exec xray by replacing the current process
	path, err := exec.LookPath("xray")
	if err != nil {
		log.Fatalf("xray binary not found in PATH: %v", err)
	}
	args := []string{"xray", "run", "-config", outPath}
	env := os.Environ()
	// Use syscall.Exec to replace this process; if it fails, fallback to exec.Command
	if err := syscall.Exec(path, args, env); err != nil {
		// fallback
		cmd := exec.Command(path, args[1:]...)
		cmd.Env = env
		cmd.Stdout = os.Stdout
		cmd.Stderr = os.Stderr
		cmd.Stdin = os.Stdin
		if err := cmd.Run(); err != nil {
			log.Fatalf("failed to start xray: %v", err)
		}
	}
}
